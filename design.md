# OwliaBot - Crypto-Native AI Agent

> ä¸º Crypto ç”¨æˆ·è®¾è®¡çš„ Self-Hosted AI Agentï¼Œå®‰å…¨ä¼˜å…ˆï¼Œæœ¬åœ°è¿è¡Œã€‚

---

## ç›®å½•

1. [è®¾è®¡ç†å¿µ](#1-è®¾è®¡ç†å¿µ)
2. [å®‰å…¨æ¨¡å‹](#2-å®‰å…¨æ¨¡å‹)
3. [æ¶æ„æ€»è§ˆ](#3-æ¶æ„æ€»è§ˆ)
4. [æ¨¡å—è®¾è®¡](#4-æ¨¡å—è®¾è®¡)
5. [æ¥å£å®šä¹‰](#5-æ¥å£å®šä¹‰)
6. [å·¥ä½œç©ºé—´](#6-å·¥ä½œç©ºé—´)
7. [ä¾èµ–ç­–ç•¥](#7-ä¾èµ–ç­–ç•¥)
8. [å¼€å‘è·¯çº¿](#8-å¼€å‘è·¯çº¿)

---

## 1. è®¾è®¡ç†å¿µ

### 1.1 æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **Local-first** | å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œç§é’¥æ°¸ä¸ç¦»å¼€è®¾å¤‡ |
| **æœ€å°ä¾èµ–** | ä¾èµ–è¶Šå°‘ï¼Œæ”»å‡»é¢è¶Šå° |
| **å¯å®¡è®¡** | ä»£ç é‡å°ï¼Œç¤¾åŒºå¯å®¡æŸ¥ |
| **æ¸ é“ç²¾ç®€** | åªæ”¯æŒ Telegram + Discord |
| **æ‰©å±•æ€§** | Tool æ¥å£è®¾è®¡è‰¯å¥½ï¼Œæ–¹ä¾¿æ‰©å±• |

### 1.2 ä¸ Clawdbot çš„å…³ç³»

OwliaBot å€Ÿé‰´ Clawdbot çš„æ¶æ„ç†å¿µï¼Œä½†é’ˆå¯¹ Crypto åœºæ™¯é‡æ–°è®¾è®¡ï¼š

| æ–¹é¢ | Clawdbot | OwliaBot |
|------|----------|----------|
| æ¸ é“ | 7+ (TG/WA/DC/Slack/Signal/iMsg/Teams) | 2 (Telegram + Discord) |
| æµè§ˆå™¨ | Playwright é›†æˆ | ä¸éœ€è¦ |
| å›¾ç‰‡å¤„ç† | sharp (native) | æ— æˆ– pure-JS |
| ç­¾å | æ—  | åˆ†å±‚å®‰å…¨æ¨¡å‹ |
| ç›®æ ‡ä¾èµ–æ•° | 50+ | < 30 |

---

## 2. å®‰å…¨æ¨¡å‹

### 2.1 å¯†é’¥åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KEY SECURITY TIERS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Tier 1: ç”¨æˆ·ç¡®è®¤å‹                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  åœºæ™¯: ä»»ä½•éœ€è¦ç­¾åç¡®è®¤çš„æ“ä½œ                                    â”‚â”‚
â”‚  â”‚  æ–¹æ¡ˆ: ç”¨æˆ· Companion App (iOS/Android)                          â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  æµç¨‹:                                                           â”‚â”‚
â”‚  â”‚  Bot â”€â”€[æ¨é€è¯·æ±‚]â”€â”€â–¶ App â”€â”€[ç”¨æˆ·ç¡®è®¤]â”€â”€â–¶ ç­¾å â”€â”€â–¶ å¹¿æ’­           â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  App èŒè´£:                                                       â”‚â”‚
â”‚  â”‚  - æ˜¾ç¤ºäº¤æ˜“è¯¦æƒ…ï¼ˆé‡‘é¢ã€ç›®æ ‡ã€Gasï¼‰                               â”‚â”‚
â”‚  â”‚  - ç”Ÿç‰©è¯†åˆ« / PIN ç¡®è®¤                                           â”‚â”‚
â”‚  â”‚  - æœ¬åœ°ç­¾åï¼Œè¿”å›ç­¾åç»“æœ                                        â”‚â”‚
â”‚  â”‚  - ç§é’¥æ°¸ä¸ç¦»å¼€ App                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  Tier 2: è‡ªåŠ¨åŒ–å°é¢                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  åœºæ™¯: è‡ªåŠ¨åŒ–æ“ä½œï¼Œä½†é‡‘é¢å—é™                                    â”‚â”‚
â”‚  â”‚  æ–¹æ¡ˆ: Session Key (å¯å¼ƒï¼Œæ— éœ€å¤‡ä»½)                              â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  ç‰¹ç‚¹:                                                           â”‚â”‚
â”‚  â”‚  - ç”± Bot æœ¬åœ°ç”Ÿæˆï¼Œä¸å¯¼å‡º                                       â”‚â”‚
â”‚  â”‚  - ä¸¢äº†å°±ä¸¢äº†ï¼Œèµ„é‡‘æŸå¤±å¯æ§                                      â”‚â”‚
â”‚  â”‚  - å®šæœŸè½®æ¢ + ä½™é¢ä¸Šé™                                           â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  ç”¨é€”: Gas ä»£ä»˜ã€å°é¢ swapã€è‡ªåŠ¨ claim ç­‰                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  Tier 3: å¤§é¢è‡ªåŠ¨åŒ–                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  åœºæ™¯: å¤§é¢ + éœ€è¦è‡ªåŠ¨åŒ–ï¼ˆå¦‚ DeFi ç­–ç•¥ï¼‰                         â”‚â”‚
â”‚  â”‚  æ–¹æ¡ˆ: æ™ºèƒ½åˆçº¦é’±åŒ… + Session Key æƒé™                           â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ Smart Wallet Contract                                      â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚â”‚
â”‚  â”‚  â”‚  Session Key æƒé™é™åˆ¶:                                     â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - åªèƒ½è°ƒç”¨ç™½åå•åˆçº¦                                      â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - å•ç¬”é™é¢ / æ—¥é™é¢                                       â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - åªèƒ½æ“ä½œç‰¹å®š token                                      â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - æœ‰æ•ˆæœŸé™åˆ¶                                              â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·ä¸»é’¥:                                                 â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - å¯éšæ—¶æ’¤é”€ session key                                  â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - å¯æå–æ‰€æœ‰èµ„é‡‘                                          â”‚  â”‚â”‚
â”‚  â”‚  â”‚  - å¯ä¿®æ”¹æƒé™è§„åˆ™                                          â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  å‚è€ƒ: ERC-4337 / Safe{Wallet} / Biconomy Session Keys          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®‰å…¨åŸåˆ™

1. **ç§é’¥éš”ç¦»**: ä¸»ç§é’¥æ°¸è¿œä¸è¿›å…¥ Bot è¿›ç¨‹
2. **æœ€å°æƒé™**: Session Key åªæœ‰æ‰§è¡Œä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™
3. **å¯æ’¤é”€**: ç”¨æˆ·éšæ—¶å¯ä»¥æ’¤é”€ä»»ä½• Session Key
4. **å¯å®¡è®¡**: æ‰€æœ‰æ“ä½œç•™ç—•ï¼Œå¯è¿½æº¯
5. **é™é¢ä¿æŠ¤**: è‡ªåŠ¨åŒ–æ“ä½œæœ‰é‡‘é¢ä¸Šé™

---

## 3. æ¶æ„æ€»è§ˆ

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OWLIABOT CORE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    ENTRY LAYER                               â”‚â”‚
â”‚  â”‚  CLI (commander) â†’ Config (yaml/env) â†’ Gateway              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                               â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    CHANNEL LAYER                             â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚â”‚
â”‚  â”‚   â”‚ Telegram   â”‚   â”‚ Discord   â”‚                            â”‚â”‚
â”‚  â”‚   â”‚ (grammy)   â”‚   â”‚ (discord.js)â”‚                          â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   ç»Ÿä¸€æ¥å£: ChannelPlugin { receive(), send() }             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                               â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    AGENT RUNTIME                             â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚   â”‚ System Prompt Builder                                  â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - è¯»å– SOUL.md / IDENTITY.md / USER.md               â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - æ³¨å…¥ Tools è¯´æ˜                                     â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - æ³¨å…¥ Runtime ä¿¡æ¯                                   â”‚ â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚   â”‚ LLM Runner                                             â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - æ”¯æŒå¤š provider (Anthropic, OpenAI, OpenRouter)    â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - Failover æœºåˆ¶                                       â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - æµå¼è¾“å‡º                                            â”‚ â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚   â”‚ Tool Executor                                          â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - ç»Ÿä¸€çš„ Tool æ¥å£                                    â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - å®‰å…¨çº§åˆ«æ£€æŸ¥                                        â”‚ â”‚â”‚
â”‚  â”‚   â”‚  - ç¡®è®¤æµç¨‹ï¼ˆå¦‚éœ€è¦ï¼‰                                  â”‚ â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                               â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SUPPORTING SYSTEMS                        â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚â”‚
â”‚  â”‚   â”‚ Cron         â”‚  â”‚ Memory       â”‚  â”‚ Session      â”‚      â”‚â”‚
â”‚  â”‚   â”‚ å®šæ—¶ä»»åŠ¡      â”‚  â”‚ è¯­ä¹‰æœç´¢     â”‚  â”‚ ä¼šè¯ç®¡ç†     â”‚      â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                               â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SIGNER LAYER                              â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚â”‚
â”‚  â”‚   â”‚ App Bridge   â”‚  â”‚ Session Key  â”‚  â”‚ Contract     â”‚      â”‚â”‚
â”‚  â”‚   â”‚ (Tier 1)     â”‚  â”‚ (Tier 2)     â”‚  â”‚ (Tier 3)     â”‚      â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¶ˆæ¯å¤„ç†æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯ (Telegram/Discord)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Channel Plugin  â”‚  æ¥æ”¶ã€è§£æã€æ„å»º MsgContext
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Security Check  â”‚  æ£€æŸ¥å‘é€è€…æƒé™ (allowlist)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Command Parse   â”‚  è§£æ /help, /status ç­‰å‘½ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
 å‘½ä»¤å“åº”   Agent å¤„ç†
    â”‚         â”‚
    â”‚         â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ System Prompt   â”‚  æ„å»ºå®Œæ•´ prompt
    â”‚    â”‚ + User Message  â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â”‚             â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ LLM Runner      â”‚  è°ƒç”¨ AIï¼Œæµå¼è¾“å‡º
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â”‚             â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ Tool Executor   â”‚  æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆå¦‚æœ‰ï¼‰
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Send   â”‚  å‘é€å›å¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ¨¡å—è®¾è®¡

### 4.1 ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ entry.ts                # ç¨‹åºå…¥å£
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ schema.ts           # é…ç½® Schema (Zod)
â”‚   â”œâ”€â”€ loader.ts           # é…ç½®åŠ è½½
â”‚   â””â”€â”€ types.ts            # é…ç½®ç±»å‹
â”‚
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ server.ts           # ä¸»æœåŠ¡å™¨
â”‚   â”œâ”€â”€ http.ts             # HTTP æ¥å£ (å¥åº·æ£€æŸ¥ç­‰)
â”‚   â””â”€â”€ bridge.ts           # å†…éƒ¨é€šä¿¡
â”‚
â”œâ”€â”€ channels/
â”‚   â”œâ”€â”€ interface.ts        # ChannelPlugin æ¥å£
â”‚   â”œâ”€â”€ registry.ts         # æ¸ é“æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ index.ts        # Telegram å®ç°
â”‚   â”‚   â”œâ”€â”€ monitor.ts      # æ¶ˆæ¯ç›‘å¬
â”‚   â”‚   â””â”€â”€ send.ts         # æ¶ˆæ¯å‘é€
â”‚   â””â”€â”€ discord/
â”‚       â”œâ”€â”€ index.ts        # Discord å®ç°
â”‚       â”œâ”€â”€ monitor.ts      # æ¶ˆæ¯ç›‘å¬
â”‚       â””â”€â”€ send.ts         # æ¶ˆæ¯å‘é€
â”‚
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ runner.ts           # LLM è°ƒç”¨ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ system-prompt.ts    # System Prompt æ„å»º
â”‚   â”œâ”€â”€ session.ts          # Session ç®¡ç†
â”‚   â”œâ”€â”€ model.ts            # Model è§£æ
â”‚   â””â”€â”€ tools/
â”‚       â”œâ”€â”€ interface.ts    # Tool æ¥å£å®šä¹‰ â˜…æ ¸å¿ƒ
â”‚       â”œâ”€â”€ registry.ts     # Tool æ³¨å†Œè¡¨
â”‚       â””â”€â”€ executor.ts     # Tool æ‰§è¡Œå™¨
â”‚
â”œâ”€â”€ workspace/
â”‚   â”œâ”€â”€ loader.ts           # åŠ è½½ SOUL/IDENTITY/USER/MEMORY
â”‚   â”œâ”€â”€ memory-search.ts    # è¯­ä¹‰æœç´¢
â”‚   â””â”€â”€ memory-index.ts     # å‘é‡ç´¢å¼•
â”‚
â”œâ”€â”€ cron/
â”‚   â”œâ”€â”€ service.ts          # Cron æœåŠ¡
â”‚   â”œâ”€â”€ scheduler.ts        # è°ƒåº¦å™¨ (croner)
â”‚   â”œâ”€â”€ store.ts            # ä»»åŠ¡æŒä¹…åŒ–
â”‚   â””â”€â”€ heartbeat.ts        # Heartbeat æ‰§è¡Œ
â”‚
â”œâ”€â”€ signer/
â”‚   â”œâ”€â”€ interface.ts        # Signer æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ types.ts            # SignRequest, SignResult
â”‚   â”œâ”€â”€ session-key.ts      # Tier 2: æœ¬åœ° session key
â”‚   â”œâ”€â”€ app-bridge.ts       # Tier 1: ä¸ Companion App é€šä¿¡
â”‚   â””â”€â”€ contract.ts         # Tier 3: æ™ºèƒ½åˆçº¦é’±åŒ…æ¥å£
â”‚
â””â”€â”€ utils/
    â”œâ”€â”€ logger.ts           # æ—¥å¿—
    â””â”€â”€ crypto.ts           # åŠ å¯†å·¥å…·
```

### 4.2 æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **config** | é…ç½®åŠ è½½ã€éªŒè¯ã€çƒ­é‡è½½ | `schema.ts` |
| **gateway** | HTTP æœåŠ¡ã€å¥åº·æ£€æŸ¥ | `server.ts` |
| **channels** | æ¶ˆæ¯æ”¶å‘ã€æ¸ é“æŠ½è±¡ | `interface.ts` |
| **agent** | LLM è°ƒç”¨ã€System Promptã€Tool æ‰§è¡Œ | `runner.ts`, `tools/interface.ts` |
| **workspace** | äººæ ¼åŠ è½½ã€è®°å¿†æœç´¢ | `loader.ts` |
| **cron** | å®šæ—¶ä»»åŠ¡ã€Heartbeat | `service.ts` |
| **signer** | ç­¾åæŠ½è±¡ã€åˆ†å±‚å®‰å…¨ | `interface.ts` |

---

## 5. æ¥å£å®šä¹‰

### 5.1 Channel æ¥å£

```typescript
// src/channels/interface.ts

export interface ChannelPlugin {
  id: ChannelId;                    // "telegram" | "discord"
  
  // ç”Ÿå‘½å‘¨æœŸ
  start(): Promise<void>;
  stop(): Promise<void>;
  
  // æ¶ˆæ¯å¤„ç†
  onMessage(handler: MessageHandler): void;
  
  // æ¶ˆæ¯å‘é€
  send(target: string, message: OutboundMessage): Promise<void>;
  
  // èƒ½åŠ›å£°æ˜
  capabilities: ChannelCapabilities;
}

export interface MessageHandler {
  (ctx: MsgContext): Promise<void>;
}

export interface MsgContext {
  // å‘é€è€…
  from: string;                     // å”¯ä¸€æ ‡è¯†
  senderName: string;               // æ˜¾ç¤ºåç§°
  senderUsername?: string;          // @username
  
  // æ¶ˆæ¯
  body: string;                     // æ¶ˆæ¯æ­£æ–‡
  messageId: string;                // æ¶ˆæ¯ ID
  replyToId?: string;               // å›å¤çš„æ¶ˆæ¯ ID
  
  // æ¸ é“
  channel: ChannelId;
  chatType: "direct" | "group" | "channel";
  groupId?: string;
  groupName?: string;
  
  // åª’ä½“
  mediaUrls?: string[];
  audioUrl?: string;
  
  // å…ƒæ•°æ®
  timestamp: number;
}

export interface ChannelCapabilities {
  reactions: boolean;
  threads: boolean;
  buttons: boolean;
  markdown: boolean;
  maxMessageLength: number;
}
```

#### ç¾¤èŠè¡Œä¸º

| åœºæ™¯ | MVP | åç»­ |
|------|-----|------|
| ç§èŠ | âœ… æ”¯æŒ | - |
| ç¾¤èŠ | âŒ å¿½ç•¥ | å¯é…ç½® |

**MVP ç­–ç•¥ï¼š**
- `chatType === "direct"` â†’ å¤„ç†
- `chatType === "group" | "channel"` â†’ å¿½ç•¥

**åç»­ç¾¤èŠé…ç½®ï¼ˆPhase 2+ï¼‰ï¼š**

```yaml
# config.yaml
channels:
  telegram:
    allowGroups: false      # MVP: false
  discord:
    allowGroups: true       # åç»­å¯å¼€å¯
    groupTrigger: "mention" # "mention" | "reply" | "all"
    groupSession: "per-user" # "per-user" | "shared"
    groupAllowList:         # å¯é€‰ï¼šé™åˆ¶è°èƒ½åœ¨ç¾¤é‡Œç”¨
      - "883499266"
```

**ç¾¤èŠ Session Keyï¼ˆåç»­ï¼‰ï¼š**

```typescript
function getSessionKey(ctx: MsgContext): SessionKey {
  if (ctx.chatType === "direct") {
    return `${ctx.channel}:${ctx.from}`;
  }
  
  // ç¾¤èŠåœºæ™¯
  if (groupSession === "per-user") {
    return `${ctx.channel}:${ctx.groupId}:${ctx.from}`;
  } else {
    return `${ctx.channel}:${ctx.groupId}`;
  }
}
```

#### Telegram æ¶ˆæ¯æ ¼å¼åŒ–

Telegram æ”¯æŒçš„ HTML æ ‡ç­¾æœ‰é™ï¼š`<b>`, `<i>`, `<code>`, `<pre>`, `<a>`, `<u>`, `<s>`

**ä¸æ”¯æŒï¼š** headers (`#`), lists (`-`), tables

**å®ç°ç­–ç•¥ï¼š** Markdown â†’ Telegram HTML è½¬æ¢

```typescript
// src/channels/telegram/index.ts

function markdownToTelegramHtml(text: string): string {
  let html = text;
  
  // Escape HTML entities
  html = html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  
  // Headers -> Bold
  html = html.replace(/^### (.+)$/gm, "\n<b>$1</b>");
  html = html.replace(/^## (.+)$/gm, "\n<b>$1</b>");
  html = html.replace(/^# (.+)$/gm, "\n<b>$1</b>\n");
  
  // Horizontal rules
  html = html.replace(/^---+$/gm, "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
  
  // Code blocks & inline code
  html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, "<pre>$2</pre>");
  html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
  
  // Bold, Italic, Strikethrough
  html = html.replace(/\*\*([^*]+)\*\*/g, "<b>$1</b>");
  html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, "<i>$1</i>");
  html = html.replace(/~~([^~]+)~~/g, "<s>$1</s>");
  
  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
  
  // List items -> bullet
  html = html.replace(/^- (.+)$/gm, "â€¢ $1");
  
  return html.trim();
}
```

**Fallbackï¼š** å¦‚æœ HTML è§£æå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§ä¸ºçº¯æ–‡æœ¬å‘é€ã€‚

### 5.2 Tool æ¥å£

```typescript
// src/agent/tools/interface.ts

export interface ToolDefinition {
  // åŸºæœ¬ä¿¡æ¯
  name: string;
  description: string;
  parameters: JsonSchema;
  
  // å®‰å…¨å…ƒæ•°æ®
  security: ToolSecurity;
  
  // æ‰§è¡Œå‡½æ•°
  execute: (params: unknown, ctx: ToolContext) => Promise<ToolResult>;
}

export interface ToolSecurity {
  level: "read" | "write" | "sign";
  
  // éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Ÿ
  confirmRequired?: boolean;
  
  // æœ€å¤§æ“ä½œé‡‘é¢ (wei)ï¼Œä»…å¯¹ sign çº§åˆ«æœ‰æ•ˆ
  maxValue?: bigint;
  
  // å…è®¸çš„ç›®æ ‡åˆçº¦ï¼ˆç™½åå•ï¼‰
  allowedContracts?: string[];
}

export interface ToolContext {
  // Session ä¿¡æ¯
  sessionKey: string;
  agentId: string;
  
  // æ³¨å…¥çš„ç­¾åå™¨
  signer: SignerInterface;
  
  // é…ç½®
  config: ToolConfig;
  
  // ç”¨æˆ·ç¡®è®¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
  requestConfirmation: (req: ConfirmationRequest) => Promise<boolean>;
}

export interface ToolResult {
  success: boolean;
  data?: unknown;
  error?: string;
}

export interface ConfirmationRequest {
  type: "transaction" | "action";
  title: string;
  description: string;
  details?: Record<string, string>;
  
  // äº¤æ˜“ç‰¹å®šå­—æ®µ
  transaction?: {
    to: string;
    value: bigint;
    data: string;
    chainId: number;
  };
}
```

#### ç¡®è®¤æµç¨‹

| å®‰å…¨çº§åˆ« | ç¡®è®¤æ–¹å¼ | ç¤ºä¾‹ |
|----------|----------|------|
| `read` | ä¸éœ€è¦ç¡®è®¤ | æŸ¥ä»·æ ¼ã€æŸ¥ä½™é¢ |
| `write` | Inline æŒ‰é’® | å‘æ¶ˆæ¯åˆ°ç¾¤ã€åˆ›å»ºæé†’ |
| `sign` | Transaction Page / Companion App | è½¬è´¦ã€åˆçº¦è°ƒç”¨ |

**ç¡®è®¤æµç¨‹åˆ†å‘ï¼š**

```typescript
async function requestConfirmation(req: ConfirmationRequest): Promise<boolean> {
  if (req.type === "transaction") {
    // sign çº§åˆ«: è·³è½¬ Transaction Page / Companion App
    return await requestTransactionApproval(req);
  } else {
    // write çº§åˆ«: Inline æŒ‰é’®
    return await requestInlineConfirmation(req);
  }
}

// Inline ç¡®è®¤ (Telegram ç¤ºä¾‹)
async function requestInlineConfirmation(req: ConfirmationRequest): Promise<boolean> {
  const msg = await bot.sendMessage(chatId, formatConfirmation(req), {
    reply_markup: {
      inline_keyboard: [[
        { text: "âœ… ç¡®è®¤", callback_data: `confirm:${req.id}` },
        { text: "âŒ å–æ¶ˆ", callback_data: `cancel:${req.id}` },
      ]],
    },
  });
  
  return await waitForCallback(req.id, { timeout: 60_000 });
}
```

**MVP ç­–ç•¥ï¼š**
- Phase 1: åªåš `read` + `sign`ï¼ˆwrite æ“ä½œæš‚ä¸å®ç°ï¼‰
- Phase 2: åŠ å…¥ `write` + Inline ç¡®è®¤

### 5.3 Signer æ¥å£

```typescript
// src/signer/interface.ts

export interface SignerInterface {
  // è·å–åœ°å€
  getAddress(): Promise<string>;
  
  // ç­¾åæ¶ˆæ¯
  signMessage(message: string): Promise<string>;
  
  // ç­¾åäº¤æ˜“
  signTransaction(tx: TransactionRequest): Promise<string>;
  
  // å‘é€äº¤æ˜“ï¼ˆç­¾å + å¹¿æ’­ï¼‰
  sendTransaction(tx: TransactionRequest): Promise<TransactionReceipt>;
  
  // å…ƒæ•°æ®
  tier: SignerTier;
  canAutoSign: boolean;
  maxAutoSignValue: bigint;
}

export type SignerTier = "app" | "session-key" | "contract";

export interface TransactionRequest {
  to: string;
  value?: bigint;
  data?: string;
  gasLimit?: bigint;
  maxFeePerGas?: bigint;
  maxPriorityFeePerGas?: bigint;
  nonce?: number;
  chainId: number;
}
```

### 5.4 Memory æ¥å£

#### å®ç°ç­–ç•¥

| é˜¶æ®µ | æ–¹æ¡ˆ | è¯´æ˜ |
|------|------|------|
| **MVP** | å…³é”®è¯åŒ¹é… | glob éå† + includes åŒ¹é…ï¼Œæ— å¤–éƒ¨ä¾èµ– |
| **åç»­** | è¯­ä¹‰æœç´¢ | Embedding API + SQLite/sqlite-vec |

**MVP å®ç°ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰ï¼š**

```typescript
// src/workspace/memory-search.ts

import { glob } from "node:fs/promises";
import { readFile } from "node:fs/promises";

export async function search(query: string, options?: SearchOptions): Promise<MemorySearchResult[]> {
  const files = await glob("memory/**/*.md", { cwd: workspaceDir });
  const results: MemorySearchResult[] = [];
  const queryLower = query.toLowerCase();
  
  for (const file of files) {
    const content = await readFile(file, "utf-8");
    const lines = content.split("\n");
    
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].toLowerCase().includes(queryLower)) {
        results.push({
          path: file,
          startLine: Math.max(0, i - 2),
          endLine: Math.min(lines.length - 1, i + 2),
          score: 1.0,  // ç®€å•åŒ¹é…ï¼Œscore å›ºå®šä¸º 1
          snippet: lines.slice(Math.max(0, i - 2), i + 3).join("\n"),
        });
      }
    }
  }
  
  return results.slice(0, options?.maxResults ?? 10);
}
```

**åç»­å‡çº§è·¯å¾„ï¼ˆè¯­ä¹‰æœç´¢ï¼‰ï¼š**

```typescript
// å‡çº§æ—¶åªéœ€æ›¿æ¢ search å®ç°ï¼Œæ¥å£ä¸å˜
// Embedding: OpenAI text-embedding-3-small æˆ– Gemini embedding-001
// å­˜å‚¨: SQLite + sqlite-vec æ‰©å±•
// ç´¢å¼•: å¯åŠ¨æ—¶å…¨é‡ + æ–‡ä»¶ watch å¢é‡
```

#### æ¥å£å®šä¹‰

```typescript
export interface MemorySearchResult {
  path: string;
  startLine: number;
  endLine: number;
  score: number;       // MVP å›ºå®š 1.0ï¼Œè¯­ä¹‰æœç´¢æ—¶ä¸ºç›¸ä¼¼åº¦
  snippet: string;
}

export interface MemoryManager {
  // æœç´¢è®°å¿†
  search(query: string, options?: SearchOptions): Promise<MemorySearchResult[]>;
  
  // è·å–æŒ‡å®šè¡Œ
  get(path: string, from?: number, lines?: number): Promise<string>;
  
  // ç´¢å¼•æ›´æ–° (MVP ä¸ºç©ºæ“ä½œï¼Œåç»­å®ç°æ—¶è§¦å‘é‡å»ºç´¢å¼•)
  reindex(): Promise<void>;
}

export interface SearchOptions {
  maxResults?: number;
  minScore?: number;   // MVP å¿½ç•¥æ­¤å‚æ•°
  paths?: string[];    // é™å®šæœç´¢è·¯å¾„
}
```

### 5.5 LLM Runner æ¥å£ï¼ˆä½¿ç”¨ pi-aiï¼‰

#### å†³ç­–ï¼šä½¿ç”¨ @mariozechner/pi-ai

**ç†ç”±ï¼š**
- å¤š provider æ”¯æŒå¼€ç®±å³ç”¨ï¼ˆAnthropic, OpenAI, Google, Bedrock, Mistralï¼‰
- ç»Ÿä¸€çš„ streaming API
- Tool calling å·²ç»å¤„ç†å¥½
- OAuth è®¤è¯å’Œåˆ·æ–°è‡ªåŠ¨å¤„ç†
- ä¸ Clawdbot ä½¿ç”¨ç›¸åŒçš„åº•å±‚åº“

**pi-ai ä¾èµ–ï¼š**
```
@anthropic-ai/sdk     â†’ Anthropic Claude
openai                â†’ OpenAI / OpenRouter  
@google/genai         â†’ Gemini
@aws-sdk/...          â†’ Bedrock
@mistralai/...        â†’ Mistral
```

#### é…ç½®ç¤ºä¾‹

```yaml
# config.yaml
model:
  provider: anthropic
  id: claude-sonnet-4-5
  
# æˆ–ä½¿ç”¨å®Œæ•´çš„ model id
model: anthropic/claude-sonnet-4-5

# OAuth è®¤è¯ï¼ˆé€šè¿‡ owliabot auth setupï¼‰
# Token ä¿å­˜åœ¨ ~/.owliabot/auth.json
```

#### æ¥å£å®šä¹‰

```typescript
// src/agent/runner.ts

import { stream, complete, getEnvApiKey } from "@mariozechner/pi-ai";
import { getOAuthApiKey, loginAnthropic, refreshAnthropicToken } from "@mariozechner/pi-ai/utils/oauth";
import type { Model, Context, AssistantMessage } from "@mariozechner/pi-ai";

export interface RunnerOptions {
  model: Model;
  maxTokens?: number;
  temperature?: number;
  tools?: ToolDefinition[];
  reasoning?: "minimal" | "low" | "medium" | "high";
}

/**
 * è°ƒç”¨ LLMï¼Œè¿”å›å®Œæ•´å“åº”
 */
export async function runLLM(
  context: Context,
  options: RunnerOptions
): Promise<AssistantMessage> {
  const apiKey = await resolveApiKey(options.model.provider);
  
  return complete(options.model, context, {
    apiKey,
    maxTokens: options.maxTokens ?? 4096,
    temperature: options.temperature,
    reasoning: options.reasoning,
  });
}

/**
 * è°ƒç”¨ LLMï¼Œè¿”å› streaming å“åº”
 */
export function streamLLM(
  context: Context,
  options: RunnerOptions
): AssistantMessageEventStream {
  const apiKey = await resolveApiKey(options.model.provider);
  
  return stream(options.model, context, {
    apiKey,
    maxTokens: options.maxTokens ?? 4096,
    temperature: options.temperature,
    reasoning: options.reasoning,
  });
}

/**
 * è§£æ API Keyï¼ˆæ”¯æŒ OAuth tokenï¼‰
 */
async function resolveApiKey(provider: string): Promise<string> {
  // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
  const envKey = getEnvApiKey(provider);
  if (envKey) return envKey;
  
  // 2. æ£€æŸ¥ OAuth credentials
  if (provider === "anthropic") {
    const credentials = await loadOAuthCredentials();
    if (credentials) {
      const result = await getOAuthApiKey("anthropic", { anthropic: credentials });
      if (result) {
        // å¦‚æœ token è¢«åˆ·æ–°ï¼Œä¿å­˜æ–°çš„ credentials
        if (result.newCredentials !== credentials) {
          await saveOAuthCredentials(result.newCredentials);
        }
        return result.apiKey;
      }
    }
  }
  
  throw new Error(`No API key for provider: ${provider}. Run 'owliabot auth setup'.`);
}
```

#### Model è§£æ

```typescript
// src/agent/models.ts

import { ANTHROPIC_MODELS, OPENAI_MODELS, GOOGLE_MODELS } from "@mariozechner/pi-ai";

export function resolveModel(modelId: string): Model {
  // æ”¯æŒ provider/model æ ¼å¼
  if (modelId.includes("/")) {
    const [provider, id] = modelId.split("/", 2);
    return getModelByProviderAndId(provider, id);
  }
  
  // æ”¯æŒåˆ«å
  const aliases: Record<string, string> = {
    "sonnet": "anthropic/claude-sonnet-4-5",
    "opus": "anthropic/claude-opus-4-5",
    "gpt-4o": "openai/gpt-4o",
    "gemini": "google/gemini-2.5-pro",
  };
  
  if (aliases[modelId]) {
    return resolveModel(aliases[modelId]);
  }
  
  // é»˜è®¤ Anthropic
  return ANTHROPIC_MODELS[modelId] ?? ANTHROPIC_MODELS["claude-sonnet-4-5"];
}
```

#### Tool Calling

pi-ai å†…ç½®äº† tool calling æ”¯æŒï¼š

```typescript
// ä½¿ç”¨ pi-ai çš„ tool æ ¼å¼
const tools = [
  {
    name: "get_price",
    description: "Get current price for a token",
    input_schema: {
      type: "object",
      properties: {
        symbol: { type: "string", description: "Token symbol" }
      },
      required: ["symbol"]
    }
  }
];

const result = await complete(model, context, {
  apiKey,
  tools,
});

// æ£€æŸ¥ tool calls
if (result.toolCalls) {
  for (const call of result.toolCalls) {
    const toolResult = await executeTool(call.name, call.input);
    // ç»§ç»­å¯¹è¯...
  }
}
```

#### OAuth é›†æˆ

pi-ai æä¾›äº†å®Œæ•´çš„ OAuth æ”¯æŒï¼š

```typescript
// src/auth/anthropic.ts

import { loginAnthropic, refreshAnthropicToken } from "@mariozechner/pi-ai/utils/oauth";

export async function setupAuth(): Promise<void> {
  const credentials = await loginAnthropic(
    // æ‰“å¼€æµè§ˆå™¨
    (url) => {
      console.log("Opening browser:", url);
      open(url);
    },
    // ç­‰å¾…ç”¨æˆ·è¾“å…¥æˆæƒç 
    async () => {
      return await promptForCode("Paste authorization code: ");
    }
  );
  
  await saveOAuthCredentials(credentials);
}

export async function refreshAuth(credentials: OAuthCredentials): Promise<OAuthCredentials> {
  return refreshAnthropicToken(credentials.refresh);
}
```

#### ç®€åŒ–çš„ç›®å½•ç»“æ„

ä½¿ç”¨ pi-ai åï¼Œå¯ä»¥åˆ é™¤ï¼š
- `src/agent/providers/` æ•´ä¸ªç›®å½•ï¼ˆpi-ai å†…ç½®ï¼‰
- `src/agent/runner.ts` å¤§å¹…ç®€åŒ–

```
src/agent/
â”œâ”€â”€ runner.ts         # ç®€åŒ–ç‰ˆï¼Œè°ƒç”¨ pi-ai
â”œâ”€â”€ models.ts         # Model è§£æå’Œåˆ«å
â”œâ”€â”€ session.ts        # Session ç®¡ç†ï¼ˆä¸å˜ï¼‰
â”œâ”€â”€ system-prompt.ts  # System Prompt æ„å»ºï¼ˆä¸å˜ï¼‰
â””â”€â”€ tools/
    â”œâ”€â”€ interface.ts  # Tool æ¥å£ï¼ˆä¸å˜ï¼‰
    â”œâ”€â”€ registry.ts   # Tool æ³¨å†Œï¼ˆä¸å˜ï¼‰
    â””â”€â”€ executor.ts   # Tool æ‰§è¡Œï¼ˆä¸å˜ï¼‰
```

### 5.6 Session æ¥å£

#### Session ç­–ç•¥

| ç»´åº¦ | MVP æ–¹æ¡ˆ | è¯´æ˜ |
|------|----------|------|
| **ç²’åº¦** | Per channel-user | TG å’Œ Discord åˆ†å¼€ï¼ŒåŒå¹³å°è¿ç»­ |
| **çª—å£** | æ»‘åŠ¨çª—å£ | ä¿ç•™æœ€è¿‘ 20 è½®å¯¹è¯ |
| **æŒä¹…åŒ–** | JSONL æ–‡ä»¶ | `~/.owliabot/sessions/{key}.jsonl` |
| **å‹ç¼©** | ä¸åš | åç»­å¯åŠ  `/compact` å‘½ä»¤ |

**Session Key æ ¼å¼ï¼š**

```
sessionKey = "${channel}:${peerId}"

ç¤ºä¾‹:
- telegram:883499266
- discord:123456789012345678
```

#### æ¥å£å®šä¹‰

```typescript
// src/agent/session.ts

export interface SessionManager {
  // è·å–æˆ–åˆ›å»º session
  get(key: SessionKey): Promise<Session>;
  
  // è¿½åŠ æ¶ˆæ¯
  append(key: SessionKey, message: Message): Promise<void>;
  
  // è·å–å†å²ï¼ˆç”¨äºæ„å»º promptï¼‰
  getHistory(key: SessionKey, maxTurns?: number): Promise<Message[]>;
  
  // æ¸…ç©º session
  clear(key: SessionKey): Promise<void>;
  
  // åˆ—å‡ºæ‰€æœ‰ sessions
  list(): Promise<SessionKey[]>;
}

export type SessionKey = `${ChannelId}:${string}`;

export interface Session {
  key: SessionKey;
  createdAt: number;
  lastActiveAt: number;
  messageCount: number;
}

export interface Message {
  role: "user" | "assistant" | "system";
  content: string;
  timestamp: number;
  toolCalls?: ToolCall[];
  toolResults?: ToolResult[];
}

// æŒä¹…åŒ–æ ¼å¼ (JSONL)
// æ¯è¡Œä¸€æ¡æ¶ˆæ¯ï¼Œä¾¿äºè¿½åŠ å†™å…¥
// ~/.owliabot/sessions/telegram:883499266.jsonl
// {"role":"user","content":"hello","timestamp":1706000000}
// {"role":"assistant","content":"hi","timestamp":1706000001}
```

#### çª—å£ç®¡ç†

```typescript
// è·å–å†å²æ—¶è‡ªåŠ¨æˆªæ–­
async function getHistory(key: SessionKey, maxTurns = 20): Promise<Message[]> {
  const allMessages = await readSessionFile(key);
  
  // ä¿ç•™æœ€è¿‘ maxTurns è½®å¯¹è¯ (user + assistant = 1 è½®)
  const turns: Message[][] = [];
  let currentTurn: Message[] = [];
  
  for (const msg of allMessages) {
    currentTurn.push(msg);
    if (msg.role === "assistant") {
      turns.push(currentTurn);
      currentTurn = [];
    }
  }
  
  // å–æœ€å N è½®
  const recentTurns = turns.slice(-maxTurns);
  return recentTurns.flat();
}
```

### 5.7 Notifications æ¥å£

#### é€šçŸ¥é€šé“ç­–ç•¥

Heartbeat ç­‰ä¸»åŠ¨æ¨é€åœºæ™¯éœ€è¦å†³å®šå‘é€åˆ°å“ªä¸ªé€šé“ã€‚

| æ–¹æ¡ˆ | MVP |
|------|-----|
| é…ç½®é»˜è®¤é€šé“ | âœ… |
| å‘åˆ°æœ€è¿‘æ´»è·ƒé€šé“ | åç»­ |
| å…¨éƒ¨é€šé“éƒ½å‘ | ä¸åš |

**é…ç½®ï¼š**

```yaml
# config.yaml
notifications:
  # ä¸»è¦é€šçŸ¥é€šé“
  channel: telegram:883499266
  
  # æˆ–å¤šé€šé“ fallbackï¼ˆåç»­æ”¯æŒï¼‰
  # channels:
  #   - telegram:883499266
  #   - discord:123456789
```

#### æ¥å£å®šä¹‰

```typescript
// src/notifications/service.ts

export interface NotificationService {
  // å‘é€é€šçŸ¥åˆ°é…ç½®çš„é€šé“
  notify(message: string, options?: NotifyOptions): Promise<void>;
  
  // å‘é€åˆ°æŒ‡å®šé€šé“
  notifyChannel(channel: string, message: string): Promise<void>;
}

export interface NotifyOptions {
  priority?: "normal" | "high";
  silent?: boolean;  // é™é»˜é€šçŸ¥ï¼ˆä¸å“é“ƒï¼‰
}

// å®ç°
async function notify(message: string, options?: NotifyOptions): Promise<void> {
  const channel = config.notifications?.channel;
  
  if (!channel) {
    // fallback: æœ€è¿‘æ´»è·ƒçš„é€šé“
    const lastActive = await getLastActiveChannel();
    if (lastActive) {
      await sendToChannel(lastActive, message);
    }
    return;
  }
  
  await sendToChannel(channel, message);
}
```

### 5.8 Auth æ¥å£

#### è®¤è¯æ–¹å¼

OwliaBot ä½¿ç”¨ Anthropic OAuth æµç¨‹è·å– tokenï¼Œä¸ Claude CLI ç›¸åŒæœºåˆ¶ã€‚

| æ–¹å¼ | è¯´æ˜ |
|------|------|
| **Setup Token** | é€šè¿‡ OAuth æµç¨‹è·å–ï¼Œä¿å­˜åˆ°æœ¬åœ° |
| Console API Key | ä¸æ”¯æŒï¼ˆéœ€è¦å¼€å‘è€…è´¦æˆ·ï¼‰ |

**OAuth Token ç‰¹ç‚¹ï¼š**
- æ ¼å¼ï¼š`sk-ant-oat01-...`
- ä½¿ç”¨ Claude Pro/Max è®¢é˜…é¢åº¦
- æœ‰ refresh tokenï¼Œå¯è‡ªåŠ¨ç»­æœŸ
- åŒä¸€è´¦æˆ·å¯æœ‰å¤šä¸ª sessionï¼Œäº’ä¸å†²çª

#### CLI å‘½ä»¤

```bash
# äº¤äº’å¼è®¾ç½®ï¼ˆæ‰“å¼€æµè§ˆå™¨æˆæƒï¼‰
owliabot auth setup

# æŸ¥çœ‹å½“å‰è®¤è¯çŠ¶æ€
owliabot auth status

# æ¸…é™¤è®¤è¯
owliabot auth logout
```

#### æ¥å£å®šä¹‰

```typescript
// src/auth/types.ts

export interface AuthToken {
  accessToken: string;
  refreshToken: string;
  expiresAt: number;  // Unix timestamp
}

export interface AuthManager {
  // å¯åŠ¨ OAuth æµç¨‹
  setup(): Promise<AuthToken>;
  
  // è·å–å½“å‰ tokenï¼ˆè‡ªåŠ¨åˆ·æ–°å¦‚æœè¿‡æœŸï¼‰
  getToken(): Promise<string | null>;
  
  // åˆ·æ–° token
  refresh(): Promise<AuthToken>;
  
  // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
  isAuthenticated(): Promise<boolean>;
  
  // æ¸…é™¤è®¤è¯
  logout(): Promise<void>;
}
```

#### å­˜å‚¨ä½ç½®

```
~/.owliabot/
â”œâ”€â”€ auth.json           # OAuth token
â””â”€â”€ config.yaml         # ç”¨æˆ·é…ç½®ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰
```

**auth.json æ ¼å¼ï¼š**

```json
{
  "anthropic": {
    "accessToken": "sk-ant-oat01-...",
    "refreshToken": "sk-ant-ort01-...",
    "expiresAt": 1769346143770
  }
}
```

#### OAuth æµç¨‹

```
1. ç”¨æˆ·è¿è¡Œ `owliabot auth setup`
2. æ‰“å¼€æµè§ˆå™¨ â†’ Anthropic ç™»å½•é¡µ
3. ç”¨æˆ·æˆæƒ
4. å›è°ƒè·å– code
5. ç”¨ code æ¢å– access_token + refresh_token
6. ä¿å­˜åˆ° ~/.owliabot/auth.json
```

**è‡ªåŠ¨åˆ·æ–°ï¼š**

```typescript
async function getToken(): Promise<string | null> {
  const auth = await loadAuth();
  if (!auth) return null;
  
  // æå‰ 5 åˆ†é’Ÿåˆ·æ–°
  if (Date.now() > auth.expiresAt - 5 * 60 * 1000) {
    const newAuth = await refresh(auth.refreshToken);
    await saveAuth(newAuth);
    return newAuth.accessToken;
  }
  
  return auth.accessToken;
}
```

---

## 6. å·¥ä½œç©ºé—´

### 6.1 æ–‡ä»¶ç»“æ„

```
workspace/
â”œâ”€â”€ AGENTS.md          # å·¥ä½œç©ºé—´è¯´æ˜ & å®‰å…¨é»˜è®¤å€¼
â”œâ”€â”€ SOUL.md            # äººæ ¼å®šä¹‰
â”‚                      # - è¯­æ°”ã€é£æ ¼
â”‚                      # - è¾¹ç•Œã€ç¦æ­¢äº‹é¡¹
â”‚                      # - é»˜è®¤è¯­è¨€
â”‚
â”œâ”€â”€ IDENTITY.md        # èº«ä»½ä¿¡æ¯
â”‚                      # - åå­— (Owlia)
â”‚                      # - Emoji (ğŸ¦‰)
â”‚                      # - Vibe
â”‚
â”œâ”€â”€ USER.md            # ç”¨æˆ·ç”»åƒ
â”‚                      # - åå¥½
â”‚                      # - æ—¶åŒº
â”‚                      # - è”ç³»æ–¹å¼
â”‚
â”œâ”€â”€ HEARTBEAT.md       # Heartbeat ä»»åŠ¡æ¸…å•
â”‚                      # - å®šæœŸæ‰§è¡Œçš„æ£€æŸ¥é¡¹
â”‚
â”œâ”€â”€ MEMORY.md          # é•¿æœŸè®°å¿†
â”‚                      # - é‡è¦å†³ç­–
â”‚                      # - ç”¨æˆ·åå¥½
â”‚                      # - æŠ€æœ¯æ–¹æ¡ˆ
â”‚
â”œâ”€â”€ TOOLS.md           # ç”¨æˆ·å¯¹å·¥å…·çš„å¤‡æ³¨
â”‚
â””â”€â”€ memory/
    â”œâ”€â”€ diary/         # æ¯æ—¥æ—¥è®° (YYYY-MM-DD.md)
    â”œâ”€â”€ weekly/        # å‘¨æ€»ç»“ (YYYY-WNN.md)
    â””â”€â”€ archive/       # å½’æ¡£
```

### 6.2 System Prompt æ„å»º

```typescript
// src/agent/system-prompt.ts

export function buildSystemPrompt(ctx: PromptContext): string {
  const sections: string[] = [];
  
  // 1. åŸºç¡€è§’è‰²
  sections.push(`You are a crypto-focused AI assistant running locally.`);
  
  // 2. SOUL.md - äººæ ¼å®šä¹‰
  const soul = loadWorkspaceFile("SOUL.md");
  if (soul) {
    sections.push(`## Persona & Boundaries\n${soul}`);
  }
  
  // 3. IDENTITY.md - èº«ä»½
  const identity = loadWorkspaceFile("IDENTITY.md");
  if (identity) {
    sections.push(`## Identity\n${identity}`);
  }
  
  // 4. USER.md - ç”¨æˆ·ç”»åƒ
  const user = loadWorkspaceFile("USER.md");
  if (user) {
    sections.push(`## User Profile\n${user}`);
  }
  
  // 5. Tools è¯´æ˜
  sections.push(`## Available Tools\n${formatToolsSection(ctx.tools)}`);
  
  // 6. Memory ä½¿ç”¨è¯´æ˜
  sections.push(`## Memory Recall
Before answering questions about prior work, decisions, or preferences:
- Use memory_search to find relevant context
- Use memory_get to retrieve specific lines
`);
  
  // 7. Runtime ä¿¡æ¯
  sections.push(`## Runtime
- Time: ${new Date().toISOString()}
- Timezone: ${ctx.timezone}
- Channel: ${ctx.channel}
- Model: ${ctx.model}
`);
  
  // 8. Heartbeat è¯´æ˜ï¼ˆå¦‚æœæ˜¯ heartbeat è§¦å‘ï¼‰
  if (ctx.isHeartbeat) {
    sections.push(`## Heartbeat
Read HEARTBEAT.md and execute the checklist.
If nothing needs attention, reply: HEARTBEAT_OK
`);
  }
  
  return sections.join("\n\n");
}
```

---

## 7. ä¾èµ–ç­–ç•¥

### 7.1 ä¾èµ–é¢„ç®—ç›˜ç‚¹

| ç±»åˆ« | ä¾èµ– | æ•°é‡ | å¤‡æ³¨ |
|------|------|------|------|
| CLI/Config | `commander`, `zod`, `yaml` | 3 | å¿…é¡» |
| HTTP/æ—¥å¿— | `tslog` | 1 | å¿…é¡» |
| å®šæ—¶ä»»åŠ¡ | `croner` | 1 | å¿…é¡» |
| Channels | `grammy`, `discord.js` | 2 | å¿…é¡» |
| **LLM** | `@mariozechner/pi-ai` | 1 | æ ¸å¿ƒï¼ˆå¸¦ 11 ä¸ªå­ä¾èµ–ï¼‰ |
| Crypto | `viem` | 1 | Phase 2+ |
| æ–‡ä»¶éå† | - | 0 | Node 22 è‡ªå¸¦ fs.glob |
| ç¯å¢ƒå˜é‡ | - | 0 | Node 20 è‡ªå¸¦ --env-file |
| **å°è®¡** | | **9** | |

**pi-ai å¸¦æ¥çš„å­ä¾èµ–ï¼ˆè‡ªåŠ¨å®‰è£…ï¼‰ï¼š**
- `@anthropic-ai/sdk` - Anthropic Claude
- `openai` - OpenAI / OpenRouter
- `@google/genai` - Google Gemini
- `@aws-sdk/client-bedrock-runtime` - AWS Bedrock
- `@mistralai/mistralai` - Mistral
- å…¶ä»–å·¥å…·åº“

### 7.2 æ ¸å¿ƒä¾èµ–è¯¦æƒ…

| ä¾èµ– | ç”¨é€” | å¯æ›¿ä»£æ€§ |
|------|------|----------|
| `@mariozechner/pi-ai` | LLM è°ƒç”¨ | æ— ï¼ˆæ ¸å¿ƒï¼‰ |
| `commander` | CLI | æ—  |
| `zod` | Schema éªŒè¯ | å¯é€‰ TypeBox |
| `grammy` | Telegram Bot | æ—  |
| `discord.js` | Discord Bot | æ—  |
| `croner` | Cron è°ƒåº¦ | å¯é€‰ node-cron |
| `tslog` | æ—¥å¿— | å¯é€‰ pino |
| `yaml` | é…ç½®è§£æ | æ—  |

### 7.3 AI Provider ç­–ç•¥

| æ–¹æ¡ˆ | ä¾èµ– | è¯´æ˜ |
|------|------|------|
| **é‡‡ç”¨** | `@mariozechner/pi-ai` | ç»Ÿä¸€ APIï¼Œå¤š provider æ”¯æŒï¼ŒOAuth å†…ç½® |

**pi-ai æ”¯æŒçš„ Providerï¼š**
- Anthropic (Claude) âœ… OAuth æ”¯æŒ
- OpenAI âœ…
- Google Gemini âœ… OAuth æ”¯æŒ
- AWS Bedrock âœ…
- Mistral âœ…
- OpenRouter âœ…
- GitHub Copilot âœ… OAuth æ”¯æŒ

### 7.4 Crypto ä¾èµ–ï¼ˆæŒ‰éœ€å¼•å…¥ï¼‰

| ä¾èµ– | ç”¨é€” | å¼•å…¥æ—¶æœº |
|------|------|----------|
| `viem` | é“¾ä¸Šäº¤äº’ | Phase 2: Tier 2 Session Key |
| `permissionless` | 4337 SDK | Phase 3: Tier 3 åˆçº¦é’±åŒ… |
| `@walletconnect/sign-client` | WalletConnect | å¦‚æœéœ€è¦è¿æ¥å¤–éƒ¨é’±åŒ… |

### 7.5 ç›®æ ‡

- **ç›´æ¥ä¾èµ–**: < 20 ä¸ª âœ… (å½“å‰ ~10)
- **å±•å¼€åæ€»åŒ…æ•°**: < 150 ä¸ª
- **æ—  native æ¨¡å—**ï¼ˆé™¤éå¿…è¦ï¼‰
- **é¢„ç®—çŠ¶æ€**: å……è¶³ ğŸŸ¢

---

## 8. å¼€å‘è·¯çº¿

### Phase 1: éª¨æ¶ (1 å‘¨)

- [ ] é¡¹ç›®åˆå§‹åŒ– (TypeScript, ESM)
- [ ] CLI å…¥å£ (commander)
- [ ] Config åŠ è½½ (zod schema)
- [ ] Workspace åŠ è½½å™¨ (SOUL/IDENTITY/USER/MEMORY)
- [ ] Tool æ¥å£å®šä¹‰
- [ ] Signer æ¥å£å®šä¹‰
- [ ] Channel æ¥å£å®šä¹‰

### Phase 2: æ¶ˆæ¯é€šé“ (1 å‘¨)

- [ ] Telegram æ¸ é“å®ç°
- [ ] Discord æ¸ é“å®ç°
- [ ] æ¶ˆæ¯è·¯ç”±
- [ ] æƒé™æ£€æŸ¥ (allowlist)

### Phase 3: Agent è¿è¡Œæ—¶ (1 å‘¨)

- [ ] System Prompt æ„å»º
- [ ] LLM Runner (Anthropic/OpenAI)
- [ ] Tool Executor
- [ ] Session ç®¡ç†
- [ ] Memory æœç´¢

### Phase 4: å®šæ—¶ä»»åŠ¡ (3 å¤©)

- [ ] Cron Service
- [ ] Heartbeat
- [ ] ä»»åŠ¡æŒä¹…åŒ–

### Phase 5: ç­¾åå±‚ (1 å‘¨)

- [ ] Session Key å®ç° (Tier 2)
- [ ] App Bridge åè®®å®šä¹‰ (Tier 1)
- [ ] Companion App åŸºç¡€ç‰ˆ

### Phase 6: æ‰©å±• (æŒç»­)

- [ ] æ›´å¤š Tools
- [ ] æ™ºèƒ½åˆçº¦é’±åŒ…é›†æˆ (Tier 3)
- [ ] éƒ¨ç½²è„šæœ¬
- [ ] æ–‡æ¡£

### Phase 7: Skills ç³»ç»Ÿ

é€šè¿‡ Skills æ‰©å±• OwliaBot åŠŸèƒ½ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚

**æ ¸å¿ƒè®¾è®¡å†³ç­–ï¼š**
- æ‰§è¡Œæ–¹å¼ï¼šJS Module (dynamic import)ï¼Œç®€å•é«˜æ•ˆ
- éš”ç¦»æ–¹å¼ï¼šDocker åŒå®¹å™¨æ¶æ„ï¼ŒSkill æ— æ³•è®¿é—®ç§é’¥
- é€šä¿¡æ–¹å¼ï¼šlocalhost HTTP + JSON-RPC
- è®¤è¯æ–¹æ¡ˆï¼šåˆ†é˜¶æ®µï¼ˆæœ¬åœ°ä¿¡ä»» â†’ ä»“åº“ä¿¡ä»» â†’ ä»£ç ç­¾åï¼‰

**è¯¦ç»†è®¾è®¡ï¼š** `docs/architecture/skills-system.md`

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- Clawdbot æ¶æ„åˆ†æ: `reference/clawdbot-analysis.md`
- ERC-4337 Account Abstraction
- Safe{Wallet} Session Keys
- Biconomy Smart Accounts

### B. è®¾è®¡å†³ç­–è®°å½•

#### DR-001: Memory æœç´¢å®ç°ç­–ç•¥

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** Memory è¯­ä¹‰æœç´¢å¦‚ä½•å®ç°ï¼Ÿ
- Embedding ä»å“ªæ¥ï¼Ÿ(æœ¬åœ°æ¨¡å‹ / API è°ƒç”¨ / ç®€å•å…³é”®è¯åŒ¹é…?)
- å‘é‡å­˜å‚¨æ–¹å¼ï¼Ÿ(å†…å­˜ / SQLite / ä¸“ç”¨å‘é‡åº“?)
- ç´¢å¼•æ›´æ–°æ—¶æœºï¼Ÿ

**é€‰é¡¹:**
1. æ ¸å¿ƒåŠŸèƒ½ - Agent ä¾èµ–è¯­ä¹‰æœç´¢å›å¿†ä¸Šä¸‹æ–‡
2. Nice-to-have - å…ˆç”¨ç®€å•å…³é”®è¯æœç´¢ï¼Œåç»­å†åŠ è¯­ä¹‰
3. å¯ä»¥ç æ‰ - MVP ä¸éœ€è¦

**å†³ç­–:** é€‰æ‹© **2. Nice-to-have**

**ç†ç”±:**
- Crypto bot åœºæ™¯ä¸‹ï¼Œè¯­ä¹‰æœç´¢ä¸æ˜¯æ ¸å¿ƒéœ€æ±‚
- ä»·æ ¼/äº¤æ˜“æ˜¯å®æ—¶æŸ¥è¯¢ï¼Œä¸éœ€è¦è®°å¿†
- é’±åŒ…åœ°å€ã€ç­–ç•¥å‚æ•°å†™åœ¨é…ç½®é‡Œ
- SOUL/IDENTITY éœ€è¦è¯»å–ï¼Œä½†ä¸éœ€è¦"æœç´¢"
- å†å²å†³ç­–å›å¿†éœ€è¦ï¼Œä½†é¢‘ç‡ä½

**å®ç°:**
- MVP: glob éå† + includes å…³é”®è¯åŒ¹é…ï¼Œæ— å¤–éƒ¨ä¾èµ–
- åç»­: å¯æ’å…¥ Embedding API + sqlite-vecï¼Œæ¥å£ä¸å˜

---

#### DR-002: LLM Provider Failover ç­–ç•¥

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** å¤š Provider æ”¯æŒå’Œ failover æœºåˆ¶å¦‚ä½•å®ç°ï¼Ÿ
- Failover è§¦å‘æ¡ä»¶ï¼Ÿ
- é‡è¯•ç­–ç•¥ï¼Ÿ
- Provider ä¼˜å…ˆçº§å¦‚ä½•é…ç½®ï¼Ÿ

**é€‰é¡¹:**
1. ç®€å•çº¿æ€§ fallback - Provider A å¤±è´¥å°±è¯• B
2. æ™ºèƒ½è·¯ç”± - æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯é‡è¯•è¿˜æ˜¯åˆ‡æ¢
3. å• Provider å°±å¤Ÿ - MVP å…ˆä¸åš failover

**å†³ç­–:** é€‰æ‹© **1. ç®€å•çº¿æ€§ fallback**

**ç†ç”±:**
- æ¯”å®Œå…¨æ²¡æœ‰ failover å¥½
- å®ç°ç®€å•ï¼ŒMVP é˜¶æ®µè¶³å¤Ÿ
- åç»­å¯å‡çº§ä¸ºæ™ºèƒ½è·¯ç”±

**å®ç°:**
- æŒ‰ priority æ’åº provider åˆ—è¡¨
- 429/5xx/timeout â†’ åˆ‡æ¢ä¸‹ä¸€ä¸ª
- 401/403/400 â†’ ç›´æ¥æŠ›å‡º
- æ‰€æœ‰ provider å¤±è´¥ â†’ æŠ›å‡ºæœ€ç»ˆé”™è¯¯

---

#### DR-003: Session ç®¡ç†ç­–ç•¥

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** Session å¦‚ä½•ç®¡ç†ï¼Ÿ
- Session ç²’åº¦ï¼Ÿ
- ä¸Šä¸‹æ–‡çª—å£ç­–ç•¥ï¼Ÿ
- æŒä¹…åŒ–æ–¹å¼ï¼Ÿ

**é€‰é¡¹ï¼ˆç²’åº¦ï¼‰:**
1. Per user å…¨å±€ - åŒä¸€ç”¨æˆ·åœ¨ TG å’Œ Discord å…±äº«ä¸Šä¸‹æ–‡
2. Per channel-user - TG å’Œ Discord åˆ†å¼€
3. Per chat - ç¾¤èŠç§èŠå„è‡ªç‹¬ç«‹

**å†³ç­–:** é€‰æ‹© **2. Per channel-user**

**ç†ç”±:**
- TG å’Œ Discord å¯èƒ½ç”¨é€”ä¸åŒ
- åŒå¹³å°å†…ä¸Šä¸‹æ–‡åº”è¯¥è¿ç»­
- é¿å…è·¨å¹³å°åœºæ™¯æ··æ·†

**å®ç°:**
- Session Key: `${channel}:${peerId}`
- çª—å£: æ»‘åŠ¨çª—å£ï¼Œä¿ç•™æœ€è¿‘ 20 è½®
- æŒä¹…åŒ–: JSONL æ–‡ä»¶ (`~/.owliabot/sessions/`)
- å‹ç¼©: MVP ä¸åšï¼Œåç»­å¯åŠ  `/compact`

---

#### DR-004: Tool ç¡®è®¤æµç¨‹

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** éç­¾åçš„ write çº§åˆ« Tool å¦‚ä½•ç¡®è®¤ï¼Ÿ

**é€‰é¡¹:**
1. Inline ç¡®è®¤ - Telegram/Discord çš„æŒ‰é’®
2. ç»Ÿä¸€èµ° Transaction Page - æ‰€æœ‰ç¡®è®¤éƒ½è·³è½¬ web
3. MVP ä¸éœ€è¦ - å…ˆåªåš read å’Œ sign çº§åˆ«

**å†³ç­–:** é€‰æ‹© **1. Inline ç¡®è®¤**ï¼Œä½† MVP é˜¶æ®µå…ˆä¸å®ç° write æ“ä½œ

**ç†ç”±:**
- Inline æŒ‰é’®ä½“éªŒæµç•…ï¼Œä¸ç¦»å¼€èŠå¤©
- ç­¾åæ“ä½œå·²ç”¨ Transaction Pageï¼Œå…¶ä»–ç”¨ inline åŒºåˆ†é‡è¦ç¨‹åº¦
- MVP é˜¶æ®µ write æ“ä½œä¸å¤šï¼Œå¯ä»¥ååŠ 

**å®ç°:**
- `read`: æ— éœ€ç¡®è®¤
- `write`: Inline æŒ‰é’®ç¡®è®¤ï¼ˆPhase 2ï¼‰
- `sign`: Transaction Page / Companion App

**MVP ç­–ç•¥:**
- Phase 1: åªåš `read` + `sign`
- Phase 2: åŠ å…¥ `write` + Inline ç¡®è®¤

---

#### DR-005: Heartbeat é€šçŸ¥é€šé“

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** Heartbeat ä¸»åŠ¨æ¨é€å‘åˆ°å“ªä¸ªé€šé“ï¼Ÿç”¨æˆ·å¯èƒ½åŒæ—¶ç”¨ TG å’Œ Discordã€‚

**é€‰é¡¹:**
1. é…ç½®é»˜è®¤é€šé“ - config.yaml é‡ŒæŒ‡å®š
2. å‘åˆ°æœ€è¿‘æ´»è·ƒçš„é€šé“ - å“ªä¸ªæœ€åæ”¶åˆ°æ¶ˆæ¯å°±å‘å“ªä¸ª
3. å…¨éƒ¨å‘ - TG å’Œ Discord éƒ½å‘

**å†³ç­–:** é€‰æ‹© **1. é…ç½®é»˜è®¤é€šé“**

**ç†ç”±:**
- ç®€å•æ˜ç¡®ï¼Œç”¨æˆ·å¯æ§
- é¿å…é‡å¤æ‰“æ‰°ï¼ˆå…¨éƒ¨å‘ï¼‰
- é¿å…å‘é”™åœ°æ–¹ï¼ˆæœ€è¿‘æ´»è·ƒå¯èƒ½ä¸å‡†ï¼‰

**å®ç°:**
```yaml
notifications:
  channel: telegram:883499266
```
- å¦‚æœæ²¡é…ç½®ï¼Œfallback åˆ°æœ€è¿‘æ´»è·ƒçš„é€šé“

---

#### DR-006: ç¾¤èŠåœºæ™¯

**æ—¥æœŸ:** 2026-01-25

**é—®é¢˜:** ç¾¤èŠåœºæ™¯å¦‚ä½•å¤„ç†ï¼Ÿ
- Bot å“åº”æ‰€æœ‰æ¶ˆæ¯è¿˜æ˜¯åªå“åº” @mentionï¼Ÿ
- Session å…±äº«è¿˜æ˜¯ per-userï¼Ÿ
- è°å¯ä»¥åœ¨ç¾¤é‡Œä½¿ç”¨ Botï¼Ÿ

**é€‰é¡¹:**
1. MVP åªåšç§èŠ - ç¾¤èŠæš‚ä¸æ”¯æŒ
2. ç¾¤èŠä¹Ÿåšï¼Œä½†é™åˆ¶è§¦å‘ - åªå“åº” @mentionï¼ŒSession per-user
3. ç¾¤èŠå…±äº«ä¸Šä¸‹æ–‡ - ç¾¤æˆå‘˜å…±äº«å¯¹è¯å†å²

**å†³ç­–:** é€‰æ‹© **1. MVP åªåšç§èŠ**

**ç†ç”±:**
- äº¤æ˜“/é’±åŒ…æ“ä½œå¿…é¡»ç§èŠï¼ˆéšç§ï¼‰
- ç¾¤èŠå¢åŠ å¤æ‚åº¦ï¼ˆè§¦å‘é€»è¾‘ã€æƒé™ã€Session ç²’åº¦ï¼‰
- å…ˆåšå¥½ç§èŠï¼Œåç»­æŒ‰éœ€åŠ ç¾¤èŠ

**å®ç°:**
- `chatType === "direct"` â†’ å¤„ç†
- `chatType === "group" | "channel"` â†’ å¿½ç•¥
- åç»­å¯é…ç½® `allowGroups`ã€`groupTrigger`ã€`groupSession`

---

#### DR-007: è®¤è¯æ–¹å¼

**æ—¥æœŸ:** 2026-01-26

**é—®é¢˜:** å¦‚ä½•è·å– Anthropic API è®¤è¯ï¼Ÿ

**é€‰é¡¹:**
1. Console API Key - ç”¨æˆ·ä» console.anthropic.com è·å–
2. OAuth Setup Token - è‡ªå·±å®ç° OAuth æµç¨‹ï¼ˆéœ€è¦ç”³è¯· client_idï¼‰
3. å¤ç”¨ Clawdbot Auth - è¯»å– clawdbot çš„ auth-profiles.json
4. å¤ç”¨ Claude CLI Token - è¯»å– Claude CLI çš„ credentials âŒ
5. ä½¿ç”¨ pi-ai çš„ OAuth å‚æ•° - å¤ç”¨ Clawdbot/pi-ai çš„ OAuth client_id å’Œ scopes

**å†³ç­–:** é€‰æ‹© **5. ä½¿ç”¨ pi-ai çš„ OAuth å‚æ•°**

**ç†ç”±:**
- Claude CLI token æœ‰ `user:sessions:claude_code` scope é™åˆ¶ï¼Œ**åªèƒ½ç”¨äº Claude Code**
- pi-aiï¼ˆClawdbot åº•å±‚åº“ï¼‰çš„ OAuth ä½¿ç”¨ä¸åŒçš„ scopesï¼Œå¯ç”¨äºæ™®é€š API è¯·æ±‚
- ä½¿ç”¨ Claude è®¢é˜…é¢åº¦ï¼ˆPro/Maxï¼‰ï¼Œæ— éœ€å¼€å‘è€…è´¦æˆ·
- ä¸ Clawdbot å®Œå…¨ç›¸åŒçš„è®¤è¯æœºåˆ¶

**ä¸ºä»€ä¹ˆ Claude CLI token ä¸èƒ½ç”¨ï¼š**

```
Claude CLI scopes:  user:inference, user:sessions:claude_code, ...
pi-ai scopes:       org:create_api_key, user:profile, user:inference

API è¿”å›é”™è¯¯ï¼š
"This credential is only authorized for use with Claude Code 
and cannot be used for other API requests."
```

**pi-ai OAuth å‚æ•°ï¼ˆä» Clawdbot æå–ï¼‰ï¼š**

```typescript
// src/auth/oauth.ts

// pi-ai çš„ client_idï¼ˆbase64 è§£ç ï¼‰
const CLIENT_ID = "9d1c250a-e61b-44d9-88ed-5944d1962f5e";

// OAuth URLs
const AUTHORIZE_URL = "https://claude.ai/oauth/authorize";
const TOKEN_URL = "https://console.anthropic.com/v1/oauth/token";
const REDIRECT_URI = "https://console.anthropic.com/oauth/code/callback";

// å…³é”®ï¼šè¿™äº› scopes å¯ä»¥ç”¨äºæ™®é€š API è¯·æ±‚
const SCOPES = "org:create_api_key user:profile user:inference";
```

**OAuth Flow å®ç°ï¼š**

```typescript
// src/auth/oauth.ts

import { generatePKCE } from "./pkce.js";

export async function loginAnthropic(
  onAuthUrl: (url: string) => void,
  onPromptCode: () => Promise<string>
): Promise<AuthToken> {
  const { verifier, challenge } = await generatePKCE();

  // Build authorization URL
  const authParams = new URLSearchParams({
    code: "true",
    client_id: CLIENT_ID,
    response_type: "code",
    redirect_uri: REDIRECT_URI,
    scope: SCOPES,
    code_challenge: challenge,
    code_challenge_method: "S256",
    state: verifier,
  });

  const authUrl = `${AUTHORIZE_URL}?${authParams.toString()}`;
  onAuthUrl(authUrl);

  // Wait for user to paste authorization code (format: code#state)
  const authCode = await onPromptCode();
  const [code, state] = authCode.split("#");

  // Exchange code for tokens
  const response = await fetch(TOKEN_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      grant_type: "authorization_code",
      client_id: CLIENT_ID,
      code,
      state,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier,
    }),
  });

  if (!response.ok) {
    throw new Error(`Token exchange failed: ${await response.text()}`);
  }

  const data = await response.json();
  return {
    accessToken: data.access_token,
    refreshToken: data.refresh_token,
    expiresAt: Date.now() + data.expires_in * 1000 - 5 * 60 * 1000,
    tokenType: "Bearer",
  };
}

export async function refreshAnthropicToken(refreshToken: string): Promise<AuthToken> {
  const response = await fetch(TOKEN_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      grant_type: "refresh_token",
      client_id: CLIENT_ID,
      refresh_token: refreshToken,
    }),
  });

  if (!response.ok) {
    throw new Error(`Token refresh failed: ${await response.text()}`);
  }

  const data = await response.json();
  return {
    accessToken: data.access_token,
    refreshToken: data.refresh_token,
    expiresAt: Date.now() + data.expires_in * 1000 - 5 * 60 * 1000,
    tokenType: "Bearer",
  };
}
```

**PKCE å®ç°ï¼š**

```typescript
// src/auth/pkce.ts

export async function generatePKCE(): Promise<{ verifier: string; challenge: string }> {
  const verifier = generateRandomString(43);
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  const challenge = base64UrlEncode(digest);
  return { verifier, challenge };
}

function generateRandomString(length: number): string {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const randomValues = new Uint8Array(length);
  crypto.getRandomValues(randomValues);
  return Array.from(randomValues, (v) => chars[v % chars.length]).join("");
}

function base64UrlEncode(buffer: ArrayBuffer): string {
  const bytes = new Uint8Array(buffer);
  let binary = "";
  for (const byte of bytes) {
    binary += String.fromCharCode(byte);
  }
  return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}
```

**API è°ƒç”¨ï¼š**

```typescript
// src/agent/providers/claude-oauth.ts

const CLAUDE_API_URL = "https://api.anthropic.com/v1/messages";

// ä½¿ç”¨ Bearer token + anthropic-beta header
headers: {
  "Content-Type": "application/json",
  "Authorization": `Bearer ${token.accessToken}`,
  "anthropic-version": "2023-06-01",
  "anthropic-beta": "oauth-2025-04-20",
}
```

**CLI å‘½ä»¤ï¼š**

```bash
# äº¤äº’å¼è®¾ç½®ï¼ˆæ‰“å¼€æµè§ˆå™¨æˆæƒï¼‰
owliabot auth setup
# 1. æ‰“å¼€æµè§ˆå™¨ â†’ claude.ai/oauth/authorize
# 2. ç”¨æˆ·ç™»å½•å¹¶æˆæƒ
# 3. å¤åˆ¶æˆæƒç ï¼ˆæ ¼å¼ï¼šcode#stateï¼‰ç²˜è´´åˆ°ç»ˆç«¯
# 4. ä¿å­˜ token åˆ° ~/.owliabot/auth.json

# æŸ¥çœ‹çŠ¶æ€
owliabot auth status

# ç™»å‡º
owliabot auth logout
```

**ç”¨æˆ·æµç¨‹ï¼š**

1. è¿è¡Œ `owliabot auth setup`
2. æµè§ˆå™¨æ‰“å¼€ Claude.ai æˆæƒé¡µé¢
3. ç™»å½•å¹¶æˆæƒ
4. å¤åˆ¶é¡µé¢ä¸Šçš„æˆæƒç ï¼Œç²˜è´´åˆ°ç»ˆç«¯
5. å¯åŠ¨ `owliabot start`

---

#### DR-008: LLM è°ƒç”¨å±‚

**æ—¥æœŸ:** 2026-01-26

**é—®é¢˜:** å¦‚ä½•æ”¯æŒå¤šä¸ª LLM providerï¼Ÿ

**é€‰é¡¹:**
1. ç¡¬ç¼–ç  switch - æ¯æ¬¡åŠ  provider æ”¹ runner.ts
2. è‡ªå·±çš„æ³¨å†Œåˆ¶ - Provider è‡ªæ³¨å†Œï¼Œrunner é€šè¿‡ registry æŸ¥æ‰¾
3. ä½¿ç”¨ pi-ai åº“ - ç»Ÿä¸€ APIï¼Œå¤š provider æ”¯æŒ

**å†³ç­–:** é€‰æ‹© **3. ä½¿ç”¨ pi-ai åº“**

**ç†ç”±:**
- å¤š provider æ”¯æŒå¼€ç®±å³ç”¨ï¼ˆAnthropic, OpenAI, Google, Bedrock, Mistralï¼‰
- ç»Ÿä¸€çš„ streaming API
- Tool calling å·²ç»å¤„ç†å¥½
- OAuth è®¤è¯å’Œåˆ·æ–°è‡ªåŠ¨å¤„ç†
- ä¸ Clawdbot ä½¿ç”¨ç›¸åŒçš„åº•å±‚åº“
- å‡å°‘è‡ªå·±ç»´æŠ¤çš„ä»£ç é‡

**å®ç°:**
```typescript
import { stream, complete } from "@mariozechner/pi-ai";
import { getOAuthApiKey } from "@mariozechner/pi-ai/utils/oauth";

// è°ƒç”¨ä»»æ„ provider
const result = await complete(model, context, { apiKey });
```

---

#### DR-009: Telegram æ¶ˆæ¯æ ¼å¼åŒ–

**æ—¥æœŸ:** 2026-01-26

**é—®é¢˜:** LLM è¾“å‡ºçš„ Markdown åœ¨ Telegram æ˜¾ç¤ºä¸ºåŸå§‹æ–‡æœ¬

**é€‰é¡¹:**
1. ä½¿ç”¨ `parse_mode: "Markdown"` - Telegram åŸç”Ÿ Markdownï¼ˆè¯­æ³•ä¸¥æ ¼ï¼Œæ˜“å‡ºé”™ï¼‰
2. ä½¿ç”¨ `parse_mode: "MarkdownV2"` - éœ€è¦å¤§é‡è½¬ä¹‰
3. è½¬æ¢ä¸º HTML - Telegram HTML æ”¯æŒæ›´ç¨³å®š

**å†³ç­–:** é€‰æ‹© **3. è½¬æ¢ä¸º HTML**

**ç†ç”±:**
- Telegram åŸç”Ÿ Markdown å¯¹ç‰¹æ®Šå­—ç¬¦éå¸¸æ•æ„Ÿï¼Œç¨æœ‰ä¸æ…å°±è§£æå¤±è´¥
- HTML è§£ææ›´å®½å®¹ï¼Œå¤±è´¥ç‡ä½
- å¯ä»¥è‡ªå®šä¹‰è½¬æ¢è§„åˆ™ï¼ˆå¦‚ `##` â†’ `<b>`ï¼Œ`-` â†’ `â€¢`ï¼‰

**å®ç°:**
- `markdownToTelegramHtml()` å‡½æ•°å¤„ç†è½¬æ¢
- è§£æå¤±è´¥æ—¶ fallback åˆ°çº¯æ–‡æœ¬
- è¯¦è§ Section 5.1 "Telegram æ¶ˆæ¯æ ¼å¼åŒ–"

---

#### DR-010: Workspace è·¯å¾„è§£æ

**æ—¥æœŸ:** 2026-01-26

**é—®é¢˜:** `config.yaml` ä¸­çš„ `workspace: ./workspace` ç›¸å¯¹è·¯å¾„åœ¨ä¸åŒ cwd ä¸‹è¡Œä¸ºä¸ä¸€è‡´

**å†³ç­–:** åœ¨ config loader ä¸­å°† workspace è·¯å¾„è§£æä¸ºç›¸å¯¹äº config æ–‡ä»¶çš„ç»å¯¹è·¯å¾„

**å®ç°:**
```typescript
// src/config/loader.ts
import { resolve, dirname } from "node:path";

// åŠ è½½ config å
const configDir = dirname(resolve(path));
config.workspace = resolve(configDir, config.workspace);
```

**æ•ˆæœ:**
- `./workspace` å§‹ç»ˆç›¸å¯¹äº `config.yaml` æ‰€åœ¨ç›®å½•
- æ— è®ºä»å“ªä¸ªç›®å½•è¿è¡Œ `owliabot start`ï¼Œéƒ½èƒ½æ­£ç¡®æ‰¾åˆ° workspace

---

(æ›´å¤šå†³ç­–å¾…è¡¥å……)
